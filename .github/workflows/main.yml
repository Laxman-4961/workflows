name: Postman Collection to APIC Import

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-postman:
    runs-on: ubuntu-latest
    env:
      APIKEY: ${{ secrets.POSTMAN_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Import Collection to Postman (Create New)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          COLLECTION_FILE: API/DocuSeal.json
        run: |
          WRAPPED_FILE=$(mktemp)
          jq -n --argjson collection "$(cat "$COLLECTION_FILE")" '{collection: $collection}' > "$WRAPPED_FILE"

          echo "Sending collection to Postman..."
          response=$(curl --location --request POST "https://api.getpostman.com/collections" \
            --header "X-Api-Key: $POSTMAN_API_KEY" \
            --header "Content-Type: application/json" \
            --data @"$WRAPPED_FILE")

          echo "Response: $response"
          COLLECTION_UID=$(echo "$response" | jq -r '.collection.id')

          if [ -z "$COLLECTION_UID" ] || [ "$COLLECTION_UID" == "null" ]; then
            echo "❌ Failed to import collection. Full response:"
            echo "$response"
            exit 1
          fi

          echo "✅ Successfully imported collection. UID: $COLLECTION_UID"
          echo "COLLECTION_UID=$COLLECTION_UID" >> $GITHUB_ENV

      - name: Run conversion script
        id: convert
        shell: bash
        run: |
          COLLECTIONID=${{ env.COLLECTION_UID }}

          if [ -z "$APIKEY" ]; then
            echo "ERROR: POSTMAN_API_KEY is not set."
            exit 1
          fi

          if [ -z "$COLLECTIONID" ]; then
            echo "ERROR: Collection ID is empty."
            exit 1
          fi

          echo "Fetching OpenAPI 3.x document for Postman Collection $COLLECTIONID"
          curl --location --request GET "https://api.getpostman.com/collections/${COLLECTIONID}/transformations" \
            --header "Content-Type: application/json" \
            --header "x-api-key: $APIKEY" | jq -r '.output' > postman-openapi-$COLLECTIONID.json

          sleep 2

          echo "Generating 'apic-friendly-secure.json' with Stub Security Scheme Definition"
          jq -r '. += {
            "components": {
              "securitySchemes": {
                "SecSchemeStub": {
                  "type": "apiKey",
                  "x-key-type": "client_id",
                  "name": "X-IBM-Client-Id",
                  "in": "header"
                }
              }
            },
            "security": [{"SecSchemeStub": []}]
          }' postman-openapi-$COLLECTIONID.json > apic-friendly-secure.json

          sleep 2

          echo "Reading Server URL field ..."
          URL=$(jq -r '.servers[0].url' apic-friendly-secure.json)
          echo "Discovered Server URL field: $URL"

          sleep 2

          echo "Populating target-url property and updating invoke definition ..."
          jq --arg URL "$URL" '. += {
            "x-ibm-configuration": {
              "assembly": {
                "execute": [{
                  "invoke": {
                    "version": "2.0.0",
                    "title": "invoke",
                    "target-url": "$(target-url)$(request.path)"
                  }
                }]
              },
              "properties": {
                "target-url": {
                  "value": $URL,
                  "description": "The URL of the target service",
                  "encoded": false
                }
              }
            }
          }' apic-friendly-secure.json > apic-friendly-secure-import.json

          sleep 2

          echo "Replacing Server URL with '/' to ensure proper construction"
          tmp=$(mktemp)
          jq '.servers = [{"url": "/"}]' apic-friendly-secure-import.json > "$tmp" && mv "$tmp" apic-friendly-secure-import.json

          echo ""
          echo "✅ Generated files:"
          echo " postman-openapi-$COLLECTIONID.json"
          echo " apic-friendly-secure.json"
          echo " apic-friendly-secure-import.json"

      - name: Upload generated JSON files
        uses: actions/upload-artifact@v3
        with:
          name: converted-postman-files
          path: |
            postman-openapi-${{ env.COLLECTION_UID }}.json
            apic-friendly-secure.json
            apic-friendly-secure-import.json
